tinymce.create('tinymce.plugins.EquationEditorPlugin', {
  init: function(editor, url) {
    var codeCogsUrl, editing;
    editing = null;
    codeCogsUrl = 'https://webstudy.codecogs.com/gif.latex?';
    editor.addCommand('mceMathquill', function(existing_latex) {
      var popup;
      existing_latex || (existing_latex = '');
      return popup = editor.windowManager.open({
        url: 'bower_components/tinymce_equation_editor/build/equation_editor.html',
        width: 820,
        height: 400,
        inline: 1,
        popup_css: false,
        title: 'Equation Editor',
        buttons: [
          {
            text: 'insert equation',
            subtype: 'primary',
            onclick: function() {
              var latex, win;
              win = editor.windowManager.getWindows()[0];
              latex = editor.windowManager.getParams()['latexInput'].mathquill('latex');
              editor.execCommand('mceMathquillInsert', latex);
              return win.close();
            }
          }, {
            text: 'cancel',
            onclick: function() {
              editing = null;
              return editor.windowManager.getWindows()[0].close();
            }
          }
        ]
      }, {
        plugin_url: url,
        existing_latex: existing_latex
      });
    });
    editor.addCommand('mceMathquillInsert', function(latex) {
      var content;
      if (!latex) {
        return;
      }
      content = '&nbsp;\n  <img class="rendered-latex" src="' + codeCogsUrl + latex + '"> \n&nbsp;';
      if (editing) {
        editor.selection.select(editing);
      }
      editing = null;
      return editor.selection.setContent(content);
    });
    editor.on('init', function() {
      return $(editor.getDoc()).on('click', '.rendered-latex', function(e) {
        var latex;
        e.stopPropagation();
        editing = this;
        latex = $(this).attr('src').replace(codeCogsUrl, '');
        return editor.execCommand('mceMathquill', latex);
      });
    });
    editor.addButton('tinymce_equation_editor', {
      title: 'Equation editor',
      cmd: 'mceMathquill',
      text: 'f(x)'
    });
    editor.on('preProcess', function(ed) {
      var mathquills;
      mathquills = ed.target.dom.select('.rendered-latex:not(.mathquill-rendered-math)');
      return $(mathquills).mathquill();
    });
    editor.on('loadContent', function(ed) {
      var mathquills;
      mathquills = ed.target.dom.select('span.rendered-latex:not(.mathquill-rendered-math)');
      return $(mathquills).mathquill();
    });
    return editor.on('setContent', function(ed) {
      var mathquills;
      mathquills = ed.target.dom.select('span.rendered-latex:not(.mathquill-rendered-math)');
      return $(mathquills).mathquill();
    });
  },
  getInfo: function() {
    return {
      longname: 'Equation Editor',
      author: 'Foraker, derived from https://github.com/laughinghan/tinymce_mathquill_plugin',
      authorurl: 'http://www.foraker.com',
      infourl: 'https://github.com/foraker/tinymce_equation_editor',
      version: '1.0'
    };
  }
});

tinymce.PluginManager.add('tinymce_equation_editor', tinymce.plugins.EquationEditorPlugin);
